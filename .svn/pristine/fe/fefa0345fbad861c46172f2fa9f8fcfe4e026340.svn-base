--Fiscal year
insert into app.fiscal_years   (fiscal_year,discription) values('70-71','For fiscal year 2070')

--Zones 

INSERT INTO app.zones (code,name) values('BA','Bagmati');
INSERT INTO app.zones (code,name) values('BH','Bheri');
INSERT INTO app.zones (code,name) values('DH','Dhawalagiri');
INSERT INTO app.zones (code,name) values('GA','Gandaki');
INSERT INTO app.zones (code,name) values('JA','Janakpur');
INSERT INTO app.zones (code,name) values('KA','Karnali');
INSERT INTO app.zones (code,name) values('KO','Koshi');
INSERT INTO app.zones (code,name) values('LU','Lumbini');
INSERT INTO app.zones (code,name) values('MA','Mahakali');
INSERT INTO app.zones (code,name) values('ME','Mechi');
INSERT INTO app.zones (code,name) values('NA','Narayani');
INSERT INTO app.zones (code,name) values('RA','Rapti');
INSERT INTO app.zones (code,name) values('SA','Sagarmatha');
INSERT INTO app.zones (code,name) values('SE','Seti');

--Districts
INSERT INTO app.districts (code,name,zone_code) values('BKT','Bhaktapur','BA');
INSERT INTO app.districts (code,name,zone_code) values('DHAD','Dhading','BA');
INSERT INTO app.districts (code,name,zone_code) values('KTM','Kathmandu','BA');
INSERT INTO app.districts (code,name,zone_code) values('KAB','Kabrepalanchowk','BA');
INSERT INTO app.districts (code,name,zone_code) values('LAL','Lalitpur','BA');
INSERT INTO app.districts (code,name,zone_code) values('NUW','Nuwakot','BA');
INSERT INTO app.districts (code,name,zone_code) values('RAS','Rasuwa','BA');
INSERT INTO app.districts (code,name,zone_code) values('SIN','Sindhupalanchowk','BA');
INSERT INTO app.districts (code,name,zone_code) values('BAN','Banke','BH');
INSERT INTO app.districts (code,name,zone_code) values('BAR','Bardia','BH');
INSERT INTO app.districts (code,name,zone_code) values('DAI','Dailekh','BH');
INSERT INTO app.districts (code,name,zone_code) values('JAJ','Jajarkot','BH');
INSERT INTO app.districts (code,name,zone_code) values('SUR','Surkhet','BH');
INSERT INTO app.districts (code,name,zone_code) values('BAG','Baglung','DH');
INSERT INTO app.districts (code,name,zone_code) values('MUS','Mustang','DH');
INSERT INTO app.districts (code,name,zone_code) values('MYA','Myagdi','DH');
INSERT INTO app.districts (code,name,zone_code) values('PARB', 'Parbat','DH');
INSERT INTO app.districts (code,name,zone_code) values('GOR','Gorkha','GA');
INSERT INTO app.districts (code,name,zone_code) values('KAS','Kaski','GA');
INSERT INTO app.districts (code,name,zone_code) values('LAM','Lamjung','GA');
INSERT INTO app.districts (code,name,zone_code) values('MAN','Manang','GA');
INSERT INTO app.districts (code,name,zone_code) values('SYA','Syangjya','GA');
INSERT INTO app.districts (code,name,zone_code) values('TAN','Tanahu','GA');
INSERT INTO app.districts (code,name,zone_code) values('DHAN','Dhanusa','JA');
INSERT INTO app.districts (code,name,zone_code) values('DOL','Dolkha','JA');
INSERT INTO app.districts (code,name,zone_code) values('MAH','Mahottari','JA');
INSERT INTO app.districts (code,name,zone_code) values('RAM','Ramechap','JA');
INSERT INTO app.districts (code,name,zone_code) values('SAR','Sarlahi','JA');
INSERT INTO app.districts (code,name,zone_code) values('SINH','Sindhuli','JA');
INSERT INTO app.districts (code,name,zone_code) values('DOLP','Dolpa','KA');
INSERT INTO app.districts (code,name,zone_code) values('HUM','Humla','KA');
INSERT INTO app.districts (code,name,zone_code) values('JUM','Jumla','KA');
INSERT INTO app.districts (code,name,zone_code) values('KALI','Kalikot','KA');
INSERT INTO app.districts (code,name,zone_code) values('MUG','Mugu','KA');
INSERT INTO app.districts (code,name,zone_code) values('BHO','Bhojpuri','KO');
INSERT INTO app.districts (code,name,zone_code) values('DHAK','Dhankuta','KO');
INSERT INTO app.districts (code,name,zone_code) values('MOR','Morang','KO');
INSERT INTO app.districts (code,name,zone_code) values('SANK','Sankhuwasabha','KO');
INSERT INTO app.districts (code,name,zone_code) values('SUN','Sunsari','KO');
INSERT INTO app.districts (code,name,zone_code) values('TER','Terthathum','KO');
INSERT INTO app.districts (code,name,zone_code) values('ARG','Arghakhanchi','LU');
INSERT INTO app.districts (code,name,zone_code) values('GUL','Gulmi','LU');
INSERT INTO app.districts (code,name,zone_code) values('KAP','Kapilvastu','LU');
INSERT INTO app.districts (code,name,zone_code) values('NAW','Nawalparasi','LU');
INSERT INTO app.districts (code,name,zone_code) values('PAL','Palpa','LU');
INSERT INTO app.districts (code,name,zone_code) values('RUP','Rupandehi','LU');
INSERT INTO app.districts (code,name,zone_code) values('BAI','Baitadi','MA');
INSERT INTO app.districts (code,name,zone_code) values('DAD','Dadeldhura','MA');
INSERT INTO app.districts (code,name,zone_code) values('DAR','Darchula','MA');
INSERT INTO app.districts (code,name,zone_code) values('KAN','Kanchanpur','MA');
INSERT INTO app.districts (code,name,zone_code) values('ILL','Illam','ME');
INSERT INTO app.districts (code,name,zone_code) values('JHA','Jhapa','ME');
INSERT INTO app.districts (code,name,zone_code) values('PANC','Panchthar','ME');
INSERT INTO app.districts (code,name,zone_code) values('TAP','Taplejung','ME');
INSERT INTO app.districts (code,name,zone_code) values('BARA','Bara','NA');
INSERT INTO app.districts (code,name,zone_code) values('CHIT','Chitwan','NA');
INSERT INTO app.districts (code,name,zone_code) values('MAK','Makawanpur','NA');
INSERT INTO app.districts (code,name,zone_code) values('PARS','Parsa','NA');
INSERT INTO app.districts (code,name,zone_code) values('RAU','Rautahat','NA');
INSERT INTO app.districts (code,name,zone_code) values('DANG','Dang','RA');
INSERT INTO app.districts (code,name,zone_code) values('PYU','Pyuthan','RA');
INSERT INTO app.districts (code,name,zone_code) values('ROL','Rolpa','RA');
INSERT INTO app.districts (code,name,zone_code) values('RUK','Rukum','RA');
INSERT INTO app.districts (code,name,zone_code) values('SAL','Salyan','RA');
INSERT INTO app.districts (code,name,zone_code) values('KHO','Khotang','SA');
INSERT INTO app.districts (code,name,zone_code) values('OKH','Okhaldunga','SA');
INSERT INTO app.districts (code,name,zone_code) values('SAP','Saptari','SA');
INSERT INTO app.districts (code,name,zone_code) values('SIR','Siraha','SA');
INSERT INTO app.districts (code,name,zone_code) values('SOLU','Solukhumbhu','SA');
INSERT INTO app.districts (code,name,zone_code) values('UDA','Udayapur','SA');
INSERT INTO app.districts (code,name,zone_code) values('ACCH','Accham','SE');
INSERT INTO app.districts (code,name,zone_code) values('BAJH','Bajhang','SE');
INSERT INTO app.districts (code,name,zone_code) values('BAJU','Bajura','SE');
INSERT INTO app.districts (code,name,zone_code) values('DOT','Doti','SE');
INSERT INTO app.districts (code,name,zone_code) values('KAILA','Kailali','SE');




-- Function: app.get_gb_summary_loan(text, text, text, text)

-- DROP FUNCTION app.get_gb_summary_loan(text, text, text, text);

CREATE OR REPLACE FUNCTION app.get_gb_summary_loan(IN fiscalyear text, IN graintype text, IN membercode text, IN cooperativecode text)
  RETURNS TABLE(name text, grain_type text, amount double precision, interest double precision, total double precision, loan_status text) AS
$BODY$ 
select name,grain_type,sum(request_amt) as request_amt,sum(interest) as interest,sum(request_amt)+sum(interest) as total,loan_status
 from (
	select m.name,
	grain_type,
	collection_date::date,
	now()::date as today_date,
	request_amt,
	ir.rate,
	(now()::timestamp::date  - collection_date::timestamp::date) as days,
	(now()::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500 as interest
	,loan_status
	 from app.grain_banking_loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1 
	 and  ir.applicable_for='GRAIN_BANKING'
	 and loan_status='Open' 
	 and lc.fiscal_year = $1
	 and member_code = $3
	 and grain_type = $2
         and lc.cooperative_code = $4

union all

	select m.name,
	grain_type,
	collection_date::date,
	closed_date::date as closed_date,
	request_amt,
	ir.rate,
	(closed_date::timestamp::date  - collection_date::timestamp::date) as days,
	(closed_date::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500 as interest
	,loan_status

	 from app.grain_banking_loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1
	  and ir.applicable_for='GRAIN_BANKING'
	  and loan_status='Closed'
	  and lc.fiscal_year = $1
	  and member_code = $3
	  and grain_type = $2
         and lc.cooperative_code = $4
	  order by name
 )y
 group by name,grain_type,loan_status
   $BODY$
  LANGUAGE sql VOLATILE
  COST 100
  ROWS 1000;
ALTER FUNCTION app.get_gb_summary_loan(text, text, text, text)
  OWNER TO postgres;




-- Function: app.get_transaction_summery(text, text, text, text)

-- DROP FUNCTION app.get_transaction_summery(text, text, text, text);

CREATE OR REPLACE FUNCTION app.get_transaction_summery(IN fiscalyear text, IN graintype text, IN grainsubtype text, IN cooperativecode text)
  RETURNS TABLE(name text, grain_sub_type text, hc_amt numeric, shrinkage_qty numeric, selling_price numeric, member_profit numeric, cooperative_fund numeric, equity numeric, miscelleneous_amount numeric, gb_total_loan_amt numeric, net_member_profit double precision) AS
$BODY$ 

select 
name
,grain_sub_types
,round(hc_amt::numeric,2) as hc_amt  
,round(shrinkage_qty::numeric,2) as shrinkage_qty  
,round(selling_price::numeric,2) as selling_price
,round(member_profit::numeric,2) as member_profit
,round(cooperative_fund::numeric,2) as cooperative_fund
,round(equity::numeric,2) as equity
,round(miscelleneous_amount::numeric,2) as miscelleneous_amount
,round(gb_total_loan_amt::numeric,2) as gb_total_loan_amt
,(round(member_profit::numeric,2) - round(cooperative_fund::numeric,2)-miscelleneous_amount-gb_total_loan_amt) as net_member_profit

from (
select (hc_qty-shrinkage_qty)*sales_rate as selling_price
		,(((hc_qty-shrinkage_qty)*sales_rate)-(hc_rate* hc_qty)) as member_profit 
		,(((hc_qty-shrinkage_qty)*sales_rate)-(hc_rate* hc_qty)) * 0.09 as cooperative_fund
		,s.member_code
		,m.name
		,s.grain_sub_type
		,(hc_rate * hc_qty) as hc_amt
		, CASE WHEN shrinkage_qty is not null then shrinkage_qty else 0 end as shrinkage_qty 
		,(pa.amount + pa.interest) gb_total_loan_amt
		, CASE WHEN e.amount is not null then e.amount else 0 end as equity
		,lh.name as grain_sub_types
		,CASE WHEN me.amount is not null then me.amount else 0 end as miscelleneous_amount
		from app.shrinkages s 
		left  join app.miscelleneous_expenses me
		on s.member_code = me.member_code 
		and s.grain_sub_type = me.grain_sub_type
		inner join app.members m 
		on m.code = s.member_code
		left join app.grain_banking_payable_loan pa
		on pa.member_code = s.member_code
		and pa.grain_sub_type = s.grain_sub_type
		inner join app.member_equities e
		on e.member_code = s.member_code
		and e.grain_sub_type = s.grain_sub_type
		inner join app.loan_sub_heads lh
		on s.grain_sub_type = lh.code
		where 1=1
		 and m.cooperative_code = $4
		 and s.grain_type =$2
		and case when $3 = 'ALL' then 1=1 else s.grain_sub_type = $3 end
		 and s.fiscal_year = $1
		 order by m.name

		 )x

$BODY$
  LANGUAGE sql VOLATILE

-- Function: app.get_wc_loan_headwise(text, text, text, text)

-- DROP FUNCTION app.get_wc_loan_headwise(text, text, text, text);



CREATE OR REPLACE FUNCTION app.get_wc_loan_headwise(IN fiscalyear text, IN graintype text, IN grainsubtype text, IN cooperativecode text)
  RETURNS TABLE(grain_type text, loan_head text, amount double precision, interest numeric, total numeric, rate double precision, loan_status text) AS
$BODY$ 

select 	grain_type, 
	name as loan_head,
	sum(request_amt) as request_amt,
	round(sum(interest)::numeric,2) as interest,
	round((sum(request_amt)+sum(interest))::numeric,2) as total ,
	rate ,
	loan_status
	from(
	
	select lh.name,
		  request_amt,
		  lh.grain_type,
		  ir.rate,
		  (now()::timestamp::date  - collection_date::timestamp::date) as days,
		  (now()::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500 as interest,
		  loan_status
		    
		  from app.working_capital_interest wc

		  inner join app.loan_heads lh
		  on wc.loan_head = lh.code
		  inner join app.interest_rates ir
		  on ir.cooperative_code = wc.cooperative_code 
		  where 1=1
		  and  ir.applicable_for='WORKING_CAPITAL' 
		  and wc.loan_status='Open'
		  and wc.grain_type = $2
		  and wc.loan_head = $3
		  and wc.fiscal_year = $1
		  and wc.cooperative_code = $4
		  
		  
		union all


		  select lh.name,request_amt,
		  lh.grain_type,
		  ir.rate,
		  (closed_date::timestamp::date  - collection_date::timestamp::date) as days,
		  (closed_date::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500 as interest,
		  loan_status
		    
		   from app.working_capital_interest wc

		  inner join app.loan_heads lh
		  on wc.loan_head = lh.code
		  inner join app.interest_rates ir
		  on ir.cooperative_code = wc.cooperative_code 

		where 1=1
		and ir.applicable_for='WORKING_CAPITAL' 
		and wc.loan_status='Closed' 
		and wc.grain_type = $2
		and wc.loan_head = $3
		and wc.fiscal_year = $1
		and wc.cooperative_code = $4
		order by name
  )y
  group by name , rate , loan_status, grain_type
   $BODY$
  LANGUAGE sql VOLATILE
  COST 100
  ROWS 1000;
ALTER FUNCTION app.get_wc_loan_headwise(text, text, text, text)
  OWNER TO postgres;




CREATE OR REPLACE FUNCTION app.get_wc_summary_loan(IN cooperativeCode text, IN fiscalYear text, IN grainType text, IN memberCode text)
  RETURNS TABLE(name text, grain_type text, amount double precision, interest double precision, total double precision, loan_status text) AS
$BODY$ 
select name,grain_type,sum(request_amt) as amount,sum(interest) as interest,sum(request_amt)+sum(interest) as total,loan_status
 from (
	select m.name,
	grain_type,
	collection_date::date,
	now()::date as today_date,
	request_amt,
	ir.rate,
	(now()::timestamp::date  - collection_date::timestamp::date) as days,
	(now()::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500 as interest
	,loan_status
	 from app.loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1 
	 and  ir.applicable_for='WORKING_CAPITAL'
	 and loan_status='Open' 
	 and lc.fiscal_year = $2
	 and member_code = $4
	 and grain_type = $3
         and lc.cooperative_code = $1
	

union all

	select m.name,
	grain_type,
	collection_date::date,
	closed_date::date as closed_date,
	request_amt,
	ir.rate,
	(closed_date::timestamp::date  - collection_date::timestamp::date) as days,
	(closed_date::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500 as interest
	,loan_status

	 from app.loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1
	  and ir.applicable_for='WORKING_CAPITAL'
	  and loan_status='Closed'
		 and lc.fiscal_year = $2
	 and member_code = $4
	 and grain_type = $3
         and lc.cooperative_code = $1
	  
	  order by name
 )y
 group by name,grain_type,loan_status

    $BODY$
  LANGUAGE sql VOLATILE



--select * from app.get_wc_summary_loan_details('ABC09','70-71','Wheat','005')

CREATE OR REPLACE FUNCTION app.get_wc_summary_loan_details(IN cooperativecode text, IN fiscalyear text, IN graintype text, IN membercode text)
  RETURNS TABLE(name text, grain_type text, amount numeric, interest numeric
  , rate numeric, days int,collection_date date,today_or_closed_date date,loan_status text) AS
$BODY$ 

select 
         name
	,grain_type
	,round(request_amt::numeric,2) as amount 
	,round(interest::numeric,2) as interest
	,round(rate::numeric,2) as rate
	,days
	,collection_date::date
	,now()::date as today_or_closed_date	
	,loan_status

from(
select m.name,
	grain_type,
	collection_date::date,
	now()::date as today_date,
	request_amt,
	ir.rate,
	(now()::timestamp::date  - collection_date::timestamp::date) as days,
	(now()::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500 as interest
	,loan_status
	 from app.loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1 
	 and  ir.applicable_for='WORKING_CAPITAL'
	 and loan_status='Open' 
	 and lc.fiscal_year = $2
	 and member_code = $4
	 and grain_type = $3
         and lc.cooperative_code = $1
	

union all

	select m.name,
	grain_type,
	collection_date::date,
	closed_date::date as closed_date,
	request_amt,
	ir.rate,
	(closed_date::timestamp::date  - collection_date::timestamp::date) as days,
	(closed_date::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500 as interest
	,loan_status

	 from app.loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
		where 1=1
		and ir.applicable_for='WORKING_CAPITAL'
		and loan_status='Closed'
		and lc.fiscal_year = $2
		and member_code = $4
		and grain_type = $3
		and lc.cooperative_code = $1
	  
	  order by name
	  )r

    $BODY$
  LANGUAGE sql VOLATILE

---------------------------------------------------------------------------------------

--select * from app.get_gb_summary_loan_details('70-71','Paddy','005','ABC09')

---drop function app.get_gb_summary_loan_details(text,text,text,text)
 
CREATE OR REPLACE FUNCTION app.get_gb_summary_loan_details(IN fiscalyear text, IN graintype text, IN membercode text, IN cooperativecode text)
  RETURNS TABLE(name text, grain_type text,grain_sub_type text,collection_date date,today_or_closed_date date, amount double precision,rate double precision,days int, interest numeric, total numeric, loan_status text) AS
$BODY$ 

select  * from
    (
	select m.name,
	grain_type,
	grain_sub_type,
	collection_date::date,
	now()::date as today_date,
	request_amt,
	ir.rate,
	(now()::timestamp::date  - collection_date::timestamp::date) as days,
	round(((now()::timestamp::date  - collection_date::timestamp::date) * request_amt *ir.rate/36500)::numeric,2) as interest,
	round((request_amt +((now()::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500))::numeric,2) as total,
	loan_status
	 from app.grain_banking_loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1 
	 and  ir.applicable_for='GRAIN_BANKING'
	 and loan_status='Open' 
	  and lc.fiscal_year = $1
	  and member_code = $3
	  and grain_type = $2
         and lc.cooperative_code = $4


union all

	select m.name,
	grain_type,
	grain_sub_type,
	collection_date::date,
	closed_date::date as closed_date,
	request_amt,
	ir.rate,
	(closed_date::timestamp::date  - collection_date::timestamp::date) as days,
      	round(((closed_date::timestamp::date  - collection_date::timestamp::date) * request_amt *ir.rate/36500)::numeric,2) as interest,
	round((request_amt +((closed_date::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500))::numeric,2) as total,
	loan_status
	 from app.grain_banking_loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1
	  and ir.applicable_for='GRAIN_BANKING'
	  and loan_status='Closed'
	   and lc.fiscal_year = $1
	  and member_code = $3
	  and grain_type = $2
         and lc.cooperative_code = $4

	  order by name, collection_date asc


)y 

  $BODY$
  LANGUAGE sql VOLATILE




-- Function: app.get_transaction_summery(text, text, text, text)

-- DROP FUNCTION app.get_transaction_summery(text, text, text, text);

CREATE OR REPLACE FUNCTION app.get_transaction_summery(IN fiscalyear text, IN graintype text, IN grainsubtype text, IN cooperativecode text)
  RETURNS TABLE(name text, grain_sub_type text, hc_amt numeric, shrinkage_qty numeric, selling_price numeric, member_profit numeric, cooperative_fund numeric, equity numeric, miscelleneous_amount numeric, gb_total_loan_amt numeric, net_member_profit double precision) AS
$BODY$ 

select 
name
,grain_sub_types
,round(hc_amt::numeric,2) as hc_amt  
,round(shrinkage_qty::numeric,2) as shrinkage_qty  
,round(selling_price::numeric,2) as selling_price
,round(member_profit::numeric,2) as member_profit
,round(cooperative_fund::numeric,2) as cooperative_fund
,round(equity::numeric,2) as equity
,round(miscelleneous_amount::numeric,2) as miscelleneous_amount
,round(gb_total_loan_amt::numeric,2) as gb_total_loan_amt
,(round(member_profit::numeric,2) - round(cooperative_fund::numeric,2)-miscelleneous_amount-gb_total_loan_amt) as net_member_profit

from (
select (hc_qty-shrinkage_qty)*sales_rate as selling_price
		,(((hc_qty-shrinkage_qty)*sales_rate)-(hc_rate* hc_qty)) as member_profit 
		,(((hc_qty-shrinkage_qty)*sales_rate)-(hc_rate* hc_qty)) * 0.09 as cooperative_fund
		,s.member_code
		,m.name
		,s.grain_sub_type
		,(hc_rate * hc_qty) as hc_amt
		, CASE WHEN shrinkage_qty is not null then shrinkage_qty else 0 end as shrinkage_qty 
		,(pa.amount + pa.interest) gb_total_loan_amt
		,0 equity --CASE WHEN e.amount is not null then e.amount else 0 end as equity
		,lh.name as grain_sub_types
		,CASE WHEN me.amount is not null then me.amount else 0 end as miscelleneous_amount
		from app.shrinkages s 
		left  join app.miscelleneous_expenses me
		on s.member_code = me.member_code 
		and s.grain_sub_type = me.grain_sub_type
		inner join app.members m 
		on m.code = s.member_code
		left join app.grain_banking_payable_loan pa
		on pa.member_code = s.member_code
		and pa.grain_sub_type = s.grain_sub_type
		
		--inner join app.member_equities e
		--on e.member_code = s.member_code
		--and e.grain_sub_type = s.grain_sub_type
		
		inner join app.loan_sub_heads lh
		on s.grain_sub_type = lh.code
		where 1=1
		 and m.cooperative_code = $4
		 and s.grain_type =$2
		and case when $3 = 'ALL' then 1=1 else s.grain_sub_type = $3 end
		 and s.fiscal_year = $1
		 order by m.name

		 )x

$BODY$
  LANGUAGE sql VOLATILE
  COST 100
  ROWS 1000;
ALTER FUNCTION app.get_transaction_summery(text, text, text, text)
  OWNER TO postgres;






	
-- Function: app.get_gb_summary_loan_details(text, text, text, text)

-- DROP FUNCTION app.get_gb_summary_loan_details(text, text, text, text);

select * from app.get_gb_summary_loan_details('70-71', 'Paddy', 'SI90', 'ABC09','Closed');

CREATE OR REPLACE FUNCTION app.get_gb_summary_loan_details(IN fiscalyear text, IN graintype text, IN membercode text, IN cooperativecode text,IN loanStatus text)
  RETURNS TABLE(name text, grain_type text, grain_sub_type text, collection_date date, today_or_closed_date date, amount double precision, rate double precision, days integer, interest numeric, total numeric, loan_status text) AS
$BODY$ 

select  * from
    (
	select m.name,
	grain_type,
	grain_sub_type,
	collection_date::date,
	now()::date as today_date,
	request_amt,
	ir.rate,
	(now()::timestamp::date  - collection_date::timestamp::date) as days,
	round(((now()::timestamp::date  - collection_date::timestamp::date) * request_amt *ir.rate/36500)::numeric,2) as interest,
	round((request_amt +((now()::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500))::numeric,2) as total,
	loan_status
	 from app.grain_banking_loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1 
	 and  ir.applicable_for='GRAIN_BANKING'
	 and loan_status='Open' 
	  and lc.fiscal_year = $1
	  and member_code = $3
	  and grain_type = $2
         and lc.cooperative_code = $4


union all

	select m.name,
	grain_type,
	grain_sub_type,
	collection_date::date,
	closed_date::date as closed_date,
	request_amt,
	ir.rate,
	(closed_date::timestamp::date  - collection_date::timestamp::date) as days,
      	round(((closed_date::timestamp::date  - collection_date::timestamp::date) * request_amt *ir.rate/36500)::numeric,2) as interest,
	round((request_amt +((closed_date::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500))::numeric,2) as total,
	loan_status
	 from app.grain_banking_loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1
	  and ir.applicable_for='GRAIN_BANKING'
	  and loan_status='Closed'
	   and lc.fiscal_year = $1
	  and member_code = $3
	  and grain_type = $2
         and lc.cooperative_code = $4

	  order by name, collection_date asc


)y 
where loan_status = $5

  $BODY$
  LANGUAGE sql VOLATILE
  COST 100
  ROWS 1000;
ALTER FUNCTION app.get_gb_summary_loan_details(text, text, text, text)
  OWNER TO postgres;


=========================

select  
	 m.name
	,case when w.amount is null then '0.00' else w.amount end as wc_amount
	,case when w.interest is null then '0.00' else w.interest end  as wc_interest 
	,case when (w.amount + w.interest) is null then '0.00' else (w.amount + w.interest) end as wc_total
	,case when g.request_amt is null then '0.00' else g.request_amt end as gb_amount
	,case when g.interest is null then '0.00' else g.interest end  as gb_interest 
	,case when (g.request_amt + g.interest) is null then '0.00' else (g.request_amt + g.interest) end as gb_total

from app.members m 
inner join (

select name,grain_type,sum(request_amt) as amount,sum(interest) as interest
,sum(request_amt)+sum(interest) as total,loan_status,member_code
 from (
	select m.name,
	grain_type,
	collection_date::date,
	now()::date as today_date,
	request_amt,
	ir.rate,
	(now()::timestamp::date  - collection_date::timestamp::date) as days,
	(now()::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500 as interest
	,loan_status
	,member_code 
	 from app.loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1 
	 and  ir.applicable_for='WORKING_CAPITAL'
	 and loan_status='Open' 
	 and lc.fiscal_year = '70-71'
	
	

union all

	select m.name,
	grain_type,
	collection_date::date,
	closed_date::date as closed_date,
	request_amt,
	ir.rate,
	(closed_date::timestamp::date  - collection_date::timestamp::date) as days,
	(closed_date::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500 as interest
	,loan_status
	,member_code
	 from app.loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1
	  and ir.applicable_for='WORKING_CAPITAL'
	  and loan_status='Closed'
	and lc.fiscal_year = '70-71'
	
	  
	 )y
 group by name,grain_type,loan_status,member_code

 ) w
 on w.member_code = m.code

left join ( 

 select name,grain_type,sum(request_amt) as request_amt,sum(interest) as interest,sum(request_amt)+sum(interest) as total,loan_status,member_code 
 from (
	select m.name,
	grain_type,
	collection_date::date,
	now()::date as today_date,
	request_amt,
	ir.rate,
	(now()::timestamp::date  - collection_date::timestamp::date) as days,
	(now()::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500 as interest
	,loan_status
	,member_code
	 from app.grain_banking_loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1 
	 and  ir.applicable_for='GRAIN_BANKING'
	 and loan_status='Open' 
	 and lc.fiscal_year = '70-71'
	
	

union all

	select m.name,
	grain_type,
	collection_date::date,
	closed_date::date as closed_date,
	request_amt,
	ir.rate,
	(closed_date::timestamp::date  - collection_date::timestamp::date) as days,
	(closed_date::timestamp::date  - collection_date::timestamp::date)  * request_amt *ir.rate/36500 as interest
	,loan_status
	,member_code 

	 from app.grain_banking_loan_collections  lc
		inner join app.members m
		on lc.member_code=m.code
		inner join app.interest_rates ir
		on ir.cooperative_code = lc.cooperative_code
	 where 1=1
	  and ir.applicable_for='GRAIN_BANKING'
	  and loan_status='Closed'
	  and lc.fiscal_year = '70-71'
	
	  order by name
 )x
 group by name,grain_type,loan_status,member_code
 ) g 
 on m.code = g.member_code

	
		

		
		






